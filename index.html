<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teknohıfz Dijital Forum (Profesyonel)</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d1117; /* GitHub dark mode background */
        }
        /* Custom scrollbar for a digital/tech look */
        .forum-container::-webkit-scrollbar {
            width: 8px;
        }
        .forum-container::-webkit-scrollbar-thumb {
            background-color: #38a169; /* Green accent */
            border-radius: 4px;
        }
        .forum-container::-webkit-scrollbar-track {
            background: #161b22;
        }
    </style>
</head>
<body>

    <div id="app" class="min-h-screen p-4 sm:p-8 flex justify-center">
        <div class="w-full max-w-4xl">
            <!-- Header -->
            <header class="text-center mb-10">
                <h1 class="text-4xl sm:text-5xl font-extrabold text-[#38a169] tracking-tight">
                    Teknohıfz Dijital (Profesyonel Sürüm)
                </h1>
                <p class="text-gray-400 mt-2 text-lg">
                    Gerçek Zamanlı ve Şifresiz Dijital Pano. Google veya Anonim Giriş ile yayınlayın.
                </p>
                <div class="mt-4 p-2 text-xs bg-gray-800 text-gray-500 rounded-lg">
                    <!-- Display user ID for collaborative identification -->
                    Kullanıcı ID: <span id="userIdDisplay" class="font-mono text-gray-400">Yükleniyor...</span>
                </div>
            </header>
            
            <!-- Auth Status and Controls -->
            <div id="authControls" class="flex flex-col sm:flex-row justify-between items-center bg-gray-900 p-4 rounded-xl mb-6 border border-gray-700">
                <div id="userInfo" class="text-sm text-gray-400 mb-2 sm:mb-0">
                    Oturum Durumu: <span id="authStatus" class="font-semibold text-red-400">Yükleniyor...</span>
                </div>
                <div class="flex space-x-2">
                    <button id="googleSignInButton" class="px-3 py-2 text-sm bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 transition duration-200 shadow-md hidden">
                        <svg class="w-4 h-4 inline mr-1 -mt-0.5" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.6 20.4H24v7.6h11.3c-.6 3.4-3.7 6.3-7.5 6.3-4.5 0-8.2-3.7-8.2-8.2s3.7-8.2 8.2-8.2c2 0 3.7.8 5.1 1.9l4.5-4.5C34.7 9.8 29.8 7 24 7c-9.9 0-18 8.1-18 18s8.1 18 18 18c9.1 0 16.5-6.7 18-15.6V20.4z"/><path fill="#FF3D00" d="M6 25c0-4.9 2-9.4 5.2-12.7L1.5 6C.5 8.6 0 11.7 0 15c0 3.7.7 7.2 2 10z"/><path fill="#4CAF50" d="M24 43c-6.8 0-12.8-3.7-16-9.2l5.1-4c2 3.8 5.8 6.6 10.9 6.6 3.5 0 6.6-1.3 9.1-3.4l4.5 4.5C36.7 41 30.7 43 24 43z"/><path fill="#1976D2" d="M43.6 20.4V24h-1.6v-3.6z"/></svg>
                        Google Giriş
                    </button>
                    <button id="signOutButton" class="px-3 py-2 text-sm bg-red-600 text-white font-bold rounded-lg hover:bg-red-700 transition duration-200 shadow-md hidden">
                        Çıkış Yap
                    </button>
                </div>
            </div>

            <!-- New Topic Form -->
            <section class="bg-[#161b22] p-6 rounded-xl shadow-2xl mb-10 border border-gray-700">
                <h2 class="text-2xl font-semibold text-gray-200 mb-4">Yeni Konu Oluştur</h2>
                <form id="newTopicForm" class="space-y-4">
                    <div>
                        <label for="userName" class="block text-sm font-medium text-gray-400 mb-1">Adınız (Google ile giriş yaparsanız otomatik dolar):</label>
                        <input type="text" id="userName" required placeholder="Örn: Dijital Analist"
                               class="w-full p-3 rounded-lg bg-gray-800 border border-gray-700 text-white placeholder-gray-500 focus:ring-green-500 focus:border-green-500 transition duration-150 disabled:opacity-50">
                    </div>
                    <div>
                        <label for="topicContent" class="block text-sm font-medium text-gray-400 mb-1">Konu Mesajınız:</label>
                        <textarea id="topicContent" required rows="4" placeholder="Buraya yazmak istediğiniz konu veya mesajı girin..."
                                  class="w-full p-3 rounded-lg bg-gray-800 border border-gray-700 text-white placeholder-gray-500 focus:ring-green-500 focus:border-green-500 resize-none transition duration-150"></textarea>
                    </div>
                    <button type="submit" id="submitButton"
                            class="w-full px-4 py-3 bg-[#38a169] text-white font-bold rounded-lg hover:bg-green-700 transition duration-200 shadow-md focus:outline-none focus:ring-4 focus:ring-green-500 focus:ring-opacity-50">
                        Yayınla (Gerçek Zamanlı Kayıt)
                    </button>
                    <p id="messageBox" class="text-center text-sm text-red-400 mt-2 hidden"></p>
                </form>
            </section>

            <!-- Existing Topics List -->
            <section>
                <h2 class="text-3xl font-bold text-gray-200 mb-6 border-b border-gray-700 pb-2">Yayınlanan Konular (Gerçek Zamanlı)</h2>
                <div id="topicsContainer" class="space-y-4 forum-container max-h-[60vh] overflow-y-auto">
                    <!-- Topics will be injected here by JavaScript -->
                    <p class="text-center text-gray-500 p-8" id="loadingMessage">Konular yükleniyor...</p>
                </div>
            </section>

        </div>
    </div>

    <!-- Firebase Imports -->
    <script type="module">
        // Mandatory Firebase imports for Firestore functionality
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            signInWithCustomToken, 
            onAuthStateChanged,
            GoogleAuthProvider, // Google Auth için yeni import
            signInWithPopup,    // Google Auth için yeni import
            signOut             // Çıkış için yeni import
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            query, 
            onSnapshot, 
            serverTimestamp 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";

        // Set log level for debugging Firebase operations
        setLogLevel('Debug');

        // Global variables provided by the Canvas environment (Mandatory to use these)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, db, auth;
        let userId = null;
        let isAuthReady = false;

        // Path for public/shared data storage
        const TOPICS_COLLECTION_PATH = `/artifacts/${appId}/public/data/forum_topics`;

        // UI Elements
        const newTopicForm = document.getElementById('newTopicForm');
        const userNameInput = document.getElementById('userName');
        const topicContentInput = document.getElementById('topicContent');
        const topicsContainer = document.getElementById('topicsContainer');
        const loadingMessage = document.getElementById('loadingMessage');
        const messageBox = document.getElementById('messageBox');
        const userIdDisplay = document.getElementById('userIdDisplay');
        const submitButton = document.getElementById('submitButton');
        
        // New Auth UI Elements
        const authStatus = document.getElementById('authStatus');
        const googleSignInButton = document.getElementById('googleSignInButton');
        const signOutButton = document.getElementById('signOutButton');


        /**
         * Shows temporary messages in the message box.
         */
        function showMessageBox(message, type = 'success') {
            messageBox.textContent = message;
            messageBox.classList.remove('hidden', 'text-green-400', 'text-red-400');
            if (type === 'error') {
                messageBox.classList.add('text-red-400');
            } else {
                messageBox.classList.add('text-green-400');
            }
            setTimeout(() => messageBox.classList.add('hidden'), 5000);
        }

        /**
         * Converts a Firestore Timestamp or a Date string into a readable format.
         * @param {object|string} timestamp - The timestamp object or ISO string.
         * @returns {string} Formatted date and time.
         */
        function formatTimestamp(timestamp) {
            if (!timestamp) return 'Şimdi';
            let date;

            if (timestamp.toDate) {
                date = timestamp.toDate();
            } else if (typeof timestamp === 'string' || typeof timestamp === 'number') {
                date = new Date(timestamp);
            } else {
                return 'Bilinmiyor';
            }

            return date.toLocaleString('tr-TR', { 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric', 
                hour: '2-digit', 
                minute: '2-digit' 
            });
        }

        /**
         * Subscribes to real-time updates from Firestore.
         */
        function subscribeToTopics() {
            if (!db || !isAuthReady) {
                console.warn("Firestore veya kimlik doğrulama hazır değil.");
                return;
            }

            const q = query(collection(db, TOPICS_COLLECTION_PATH));

            const unsubscribe = onSnapshot(q, (snapshot) => {
                const topics = [];
                snapshot.forEach((doc) => {
                    topics.push({ id: doc.id, ...doc.data() });
                });

                // Sort topics client-side (newest first)
                topics.sort((a, b) => {
                    const timeA = a.timestamp?.toDate ? a.timestamp.toDate().getTime() : new Date(0).getTime();
                    const timeB = b.timestamp?.toDate ? b.timestamp.toDate().getTime() : new Date(0).getTime();
                    return timeB - timeA; 
                });

                renderTopics(topics);
            }, (error) => {
                console.error("Konuları dinleme hatası: ", error);
                showMessageBox('Konular yüklenirken bir hata oluştu.', 'error');
            });
            
            return unsubscribe; 
        }

        /**
         * Renders the topics list to the UI. (No change)
         */
        function renderTopics(topics) {
            topicsContainer.innerHTML = '';
            loadingMessage.classList.add('hidden');

            if (topics.length === 0) {
                topicsContainer.innerHTML = '<p class="text-center text-gray-500 p-4">Henüz yayınlanmış bir konu yok. İlk konuyu siz başlatın!</p>';
                return;
            }

            topics.forEach(topic => {
                const topicElement = document.createElement('div');
                topicElement.className = 'p-5 bg-gray-800 rounded-lg shadow-md border border-gray-700 hover:border-[#38a169] transition duration-150';
                
                const formattedTime = formatTimestamp(topic.timestamp);

                topicElement.innerHTML = `
                    <div class="flex justify-between items-start mb-2 border-b border-gray-700 pb-2">
                        <div class="text-lg font-bold text-gray-200">
                            ${topic.name || 'Anonim Kullanıcı'}
                        </div>
                        <div class="text-xs text-gray-500 mt-1 flex-shrink-0 ml-4">
                            ${formattedTime}
                        </div>
                    </div>
                    <p class="text-base text-gray-300 whitespace-pre-wrap">${topic.topic}</p>
                `;
                topicsContainer.appendChild(topicElement);
            });
        }

        /**
         * Handles Google Sign-in using a popup.
         */
        async function signInWithGoogle() {
            try {
                const provider = new GoogleAuthProvider();
                await signInWithPopup(auth, provider);
                showMessageBox('Google ile başarılı bir şekilde giriş yaptınız!', 'success');
                // Auth state listener handles UI update
            } catch (error) {
                console.error("Google Sign-in failed: ", error);
                showMessageBox(`Google ile giriş yapılamadı: ${error.message}`, 'error');
            }
        }

        /**
         * Handles user sign-out.
         */
        async function handleSignOut() {
            try {
                await signOut(auth);
                // Sign out will trigger onAuthStateChanged with a null user.
                // We immediately sign in anonymously to keep the session alive 
                // as required by the environment's security rules.
                await signInAnonymously(auth); 
                showMessageBox('Başarıyla çıkış yaptınız ve anonim olarak giriş yapıldı.', 'success');
            } catch (error) {
                console.error("Sign-out failed: ", error);
                showMessageBox(`Çıkış yapılamadı: ${error.message}`, 'error');
            }
        }


        /**
         * Handles form submission and adds a new topic to Firestore.
         */
        async function addNewTopic(event) {
            event.preventDefault();

            if (!db || !userId) {
                showMessageBox('Sistem henüz hazır değil, lütfen bekleyin.', 'error');
                return;
            }

            submitButton.disabled = true;
            submitButton.textContent = 'Yayınlanıyor...';
            messageBox.classList.add('hidden');

            let name;
            // Get current user details
            const currentUser = auth.currentUser;

            // Determine the name to use based on the authentication status
            if (currentUser && !currentUser.isAnonymous) {
                // Use official name/email if logged in with Google/Email
                name = currentUser.displayName || currentUser.email || 'Kimliği Doğrulanmış Kullanıcı';
            } else {
                // Use input value if anonymous
                name = userNameInput.value.trim() || 'Anonim';
            }
            
            const topic = topicContentInput.value.trim();

            if (topic.length === 0) {
                showMessageBox('Lütfen bir konu mesajı giriniz.', 'error');
                submitButton.disabled = false;
                submitButton.textContent = 'Yayınla (Gerçek Zamanlı Kayıt)';
                return;
            }

            try {
                // Add the new topic document to the public collection
                await addDoc(collection(db, TOPICS_COLLECTION_PATH), {
                    name: name,
                    topic: topic,
                    timestamp: serverTimestamp(), // Use server timestamp for consistency
                    userId: userId 
                });

                // Clear input and display success
                topicContentInput.value = '';
                if (currentUser.isAnonymous) {
                    // Only save last entered name if anonymous
                    localStorage.setItem('lastUserName', userNameInput.value.trim()); 
                }
                
                showMessageBox('Konu başarıyla yayınlandı!', 'success');

            } catch (error) {
                console.error("Error adding new topic: ", error);
                showMessageBox('Konu yayınlanırken bir sorun oluştu: ' + error.message, 'error');
            } finally {
                submitButton.disabled = false;
                submitButton.textContent = 'Yayınla (Gerçek Zamanlı Kayıt)';
            }
        }

        /**
         * Initializes Firebase and handles user authentication.
         */
        async function initializeFirebase() {
            try {
                if (!app) {
                    app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);
                }

                // Load last used username for anonymous users
                const lastUserName = localStorage.getItem('lastUserName');
                if (lastUserName) {
                    userNameInput.value = lastUserName;
                }

                // Mandatory initial sign-in logic (Anonymous or Custom Token)
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                
                // Set up authentication state listener
                onAuthStateChanged(auth, (user) => {
                    isAuthReady = true;
                    if (user) {
                        userId = user.uid;
                        
                        // Update UI based on Auth status
                        if (user.isAnonymous) {
                            // ANONYMOUS STATE
                            authStatus.textContent = 'Anonim (Misafir)';
                            authStatus.classList.remove('text-green-400');
                            authStatus.classList.add('text-red-400');
                            userIdDisplay.textContent = user.uid;
                            googleSignInButton.classList.remove('hidden');
                            signOutButton.classList.add('hidden');
                            userNameInput.disabled = false;
                            userNameInput.placeholder = "Örn: Dijital Analist (Anonim)";
                        } else {
                            // LOGGED IN STATE (Google/Email)
                            const displayName = user.displayName || user.email;
                            authStatus.textContent = displayName;
                            authStatus.classList.remove('text-red-400');
                            authStatus.classList.add('text-green-400');
                            userIdDisplay.textContent = user.uid;
                            googleSignInButton.classList.add('hidden');
                            signOutButton.classList.remove('hidden');
                            
                            // Lock username input and use official name
                            userNameInput.value = displayName;
                            userNameInput.disabled = true; 
                        }

                        subscribeToTopics();
                    } else {
                        // NO USER STATE (After explicit sign out, before anon re-sign-in)
                        userId = null;
                        userIdDisplay.textContent = 'Oturum Yok';
                        authStatus.textContent = 'Oturum Açın';
                        authStatus.classList.add('text-red-400');
                        googleSignInButton.classList.remove('hidden');
                        signOutButton.classList.add('hidden');
                        
                        renderTopics([]);
                    }
                });

                // Add event listeners for new buttons
                googleSignInButton.addEventListener('click', signInWithGoogle);
                signOutButton.addEventListener('click', handleSignOut);
                newTopicForm.addEventListener('submit', addNewTopic);

            } catch (error) {
                console.error("Firebase initialization or auth error: ", error);
                showMessageBox('Uygulama başlatılırken kritik bir hata oluştu.', 'error');
            }
        }
        
        // Start the application
        initializeFirebase();
    </script>
</body>
</html>
